/**
  author: zjh 2017/04/15 11:02:17
  Thanks to https://github.com/fordth/jinqJs/
  demo:
    new jql().from(datas)
             .where((row) => row.field > 3)
             .groupBy("field", "field1", "field2")
             .sum("field4")
             .orderBy("field4")
             .desc()
             .select("field", "field1", "field2", "field4")
*/
'use strict';
var jql=function(){var a={collections:[],result:[],groups:[]},b={isEmpty:function isEmpty(n){return'undefined'==typeof n||0===n.length},isArray:function isArray(n){return b.hasProperty(n,'length')&&!b.isString(n)&&!b.isFunction(n)},isObject:function isObject(n){return null!==n&&(n.constructor===Object||b.isArray(n))},isString:function isString(n){return null!==n&&n.constructor===String},hasProperty:function hasProperty(n,o){return n[o]!==void 0},isFunction:function isFunction(n){return'function'==typeof n},isNumber:function isNumber(n){return'number'==typeof n},condenseToFields:function condenseToFields(n,o){var p={};if(b.isArray(o))for(var s,q=0;q<o.length;q++)s=o[q],p[s]=b.hasProperty(n,s)?n[s]:0;else p[o]=b.hasProperty(n,o)?n[o]:0;return p},arrayFindItem:function arrayFindItem(n,o,p){p=p||!1;for(var q=!1,s=[],t=0;t<n.length;t++){q=!1;var u=n[t],v=b.isObject(u);for(var w in o){if(!v&&u!==o[w]||v&&u[w]!==o[w]){q=!1;break}q=!0}if(q){if(p)return u;s.push(u)}}return 0===s.length?null:s},arrayFindFirstItem:function arrayFindFirstItem(n,o){return b.arrayFindItem(n,o,!0)},concatCollection:function concatCollection(n){for(var o=[],p=0;p<n.length;p++)o=o.concat(n[p]);return o},aggregator:function aggregator(n,o){for(var p=[],q=null,s=null,t=null,u=0;u<a.result.length;u++)if(q=b.condenseToFields(a.result[u],a.groups),s=b.condenseToFields(a.result[u],n),t=b.arrayFindFirstItem(p,q),null==t){for(var v in t={},q)t[v]=q[v];for(var w in s)t[w]=o(t[w],s[w],JSON.stringify(q)+w);p.push(t)}else for(var w in s)t[w]=o(t[w],s[w],JSON.stringify(q)+w);return a.groups=[],p}};this.from=function c(){if(0===arguments.length)return jql;for(var n=0;n<arguments.length;n++)a.collections.push(arguments[n]);return a.result=b.concatCollection(a.collections),this},this.where=function d(n){return'undefined'==typeof n?jql:b.isFunction(n)?(a.result=a.result.filter(n),this):jql},this.select=function e(){if(b.isEmpty(a.result))return[];if(0===arguments.length)return a.result;var n=[],o=Array(a.result.length);n=arguments;for(var q,p=0;p<a.result.length;p++){q={};for(var t,s=0;s<n.length;s++)t=n[s],q[t]=0===a.result[p][t]?0:a.result[p][t]||null;o[p]=q}return o},this.sum=function g(){var n=null;if(0===a.groups.length){n=0;for(var o=0;o<a.result.length;o++)n+=0===arguments.length?a.result[o]:a.result[o][arguments[0]];a.result=[n]}else n={},a.result=b.aggregator(arguments,function(p,q,s){return b.hasProperty(n,s)||(n[s]=0),n[s]+=q,n[s]});return this},this.groupBy=function f(){return a.groups=b.concatCollection(arguments),this},this.avg=function h(){var n=null;if(0===a.groups.length){n=0;for(var o=0;o<a.result.length;o++)n+=0===arguments.length?a.result[o]:a.result[o][arguments[0]];a.result=[n/a.result.length]}else n={},a.result=b.aggregator(arguments,function(p,q,s){return b.hasProperty(n,s)||(n[s]={count:0,sum:0}),n[s].count++,n[s].sum+=q,n[s].sum/n[s].count});return this},this.orderBy=function i(){if(0===arguments.length)return this;if(0==a.result.length)return this;var n=arguments;if(1===n.length){var o=n[0];b.isFunction(o)?a.result.sort(o):b.isString(o)&&b.isNumber(a.result[0][o])?a.result.sort(function(p,q){var s=p[o],t=q[o];return s-t}):a.result.sort(function(p,q){var s=JSON.stringify(b.condenseToFields(p,n)),t=JSON.stringify(b.condenseToFields(q,n));return s.localeCompare(t)})}return this},this.desc=function j(){return a.result.reverse(),this},this.top=function k(n){var o;return o=Math.abs(parseInt(n)),a.result=0>n?a.result.slice(-1*o):a.result.slice(0,o),this},this.distinct=function m(n){if('undefined'==typeof n)return this;for(var o=[],p=null,q=0;q<a.result.length;q++)p=b.condenseToFields(a.result[q],n),null===b.arrayFindFirstItem(o,p)&&o.push(p);return a.result=o,this}};(function(a,b){'undefined'!=typeof define&&define.amd?define('jql',[],function(){return b}):'undefined'!=typeof module&&module.exports?module.exports=b:a.jql=b})('undefined'==typeof window?void 0:window,jql);
